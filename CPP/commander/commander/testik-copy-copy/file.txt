#!/bin/sh
#ternnet.sh
#**********************************************************************
#Переменные
HOSTNAME=`hostname`
I=`cat whoami`
DHCPLOG='/var/log/dhcp.log'
PATH='/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/sbin:/usr/sbin:/root/bin:/root/bin'
DATEFR=`date '+%b %d %T'`
NETTOSW=`ifconfig | egrep -o 'Bcast\:22\.22\.22\.|Bcast\:11\.11\.11\.' | sed s/Bcast\://`
LOG='/var/log/ternnet.log'
STARP='/etc/ethers'
DHCPDIR="/etc/dhcp"
#**********************************************************************
check() {
	if [ $1 = 'showsw' ]; then
		IPSW="$2"
		#Проверка первых трёх октетов в IP адресе свича
		if [ ! "$IPSW" ]; then
			echo '***********************************************************************'
			echo "Ошибка ввода: IP адрес свича, не введён"
			echo '***********************************************************************'
			exit 1
		fi;
	else IPSW="$3"; fi
	IPAB="$2"
	PORT="$4"
	#Проверка первых двух октетов в IP адресе абонента
	if [ ! "`echo $IPAB  | grep '192.168.'`" ]; then IPAB="192.168.${IPAB}"; fi
	if [ ! "`echo $IPSW  | grep $NETTOSW`" ]; then IPSW="${NETTOSW}${IPSW}"; fi
	#Проверка переменной с номером порта свича
	if [ "$1" = "addabon" ] && [ ! "$PORT" ]; then echo "Ошибка: Не введён порт свича..."; exit 1; fi
	local THREEOK=`echo $IPAB | sed -r 's/^192\.168\.([0-9]{1,2})\.[0-9]{1,3}$/\1/'`
	local FOUROK=`echo $IPAB | sed -r 's/^192\.168\.[0-9]{1,2}\.([0-9]{1,3})$/\1/'`
	if [ $1 != 'showsw' ]; then
		#Проверка корректности IP адреса абонента
		local FORMULAAB=`echo $IPAB | sed -r 's/^192\.168\.([0-9]{1,2})\.([0-9]{1,3})$/\1\2/' | grep -oe [0-9] | wc -m`
		if [ ! "$1" ]; then
			echo '***********************************************************************'
			echo "Ошибка ввода: IP адрес абонента, не введён"
			echo '***********************************************************************'
			exit 1
		elif [ "$FORMULAAB" -gt '10' ] || [ "$FORMULAAB" -lt '4' ] || [ "$FOUROK" -eq '0' ] || [ "$FOUROK" -eq '1' ] || [ "$FOUROK" -gt '254' ]; then
			echo '***********************************************************************'
			echo "Ошибка ввода: IP адрес абонента ${IPAB}, не корректный..."
			echo '***********************************************************************'
			exit 1
		fi
		#Сравнение IP адреса абонента с возможными подсетями на этом роутере
		local CHECKSUBNET=`cat /etc/sysconfig/network-scripts/ifcfg-eth[0,1].* | sed -r  '/111$|222$|1112$/d' | egrep -o 'DEVICE=eth[0-1]\.[0-9]{1,2}' | sed -r 's/DEVICE\=eth[0-1]\.//' | grep -e ^${THREEOK}$`
		if [ ! "$CHECKSUBNET" ]; then
			echo '***********************************************************************'
			echo "Ошибка: IP адрес абонента ${IPAB}, не имеет шлюз на роутере ${HOSTNAME}..."
			echo '***********************************************************************'
			exit 1
		fi
	fi
	#
	#Проверка корректности IP адреса свича
	if [ "$1" = 'addabon' ] || [ "$1" = 'showsw' ]; then
		if [ ! "`grep -m 1 -wo $IPSW $STARP`" ]; then
			echo '***********************************************************************'
			echo "Ошибка ввода: IP адрес свича ${IPSW}, в /etc/ethers не найден..."
			echo '***********************************************************************'
			exit 1
		fi
	fi
	#Проверка корректности порта свича
	if [ "$1" = 'addabon' ]; then
		local CHKINT=`echo $PORT | sed -r 's/[0-9]{1,}//'`
		if [ "$CHKINT" ]; then
			echo '***********************************************************************'
			echo "Ошибка ввода: Порт ${PORT}, не целочисленный..."
			echo '***********************************************************************'
			exit 1
		elif [ "$PORT" -gt '24' ] || [ "$PORT" -lt '1' ]; then
			echo '***********************************************************************'
			echo "Ошибка ввода: Порт ${PORT}, не корректный..."
			echo '***********************************************************************'
			exit 1
		fi
	fi
	DHCPCLASS="${DHCPDIR}/${THREEOK}segment_classes"
	LOGIN=`echo "tern${THREEOK}${FOUROK}"`
	$1
}
addabon() {
	local CHKUSEPORT=`egrep -o "\"$IPSW\".{1,}" $DHCPCLASS | egrep -o "\)\)\=\"$PORT\"\ and" | egrep -o '[0-9]{1,2}'`
	local CHKUSEPORTLOGIN=`grep \"$IPSW\" $DHCPCLASS | grep "))\=\"$PORT\"\ and" | egrep -o 'tern[0-9]{3,5}'`
	#Проверка использования IP адреса абонента
	if [ ! "`egrep '\"switch\"|\"port\"' $DHCPCLASS | grep -o $LOGIN`" ]; then
		echo '***********************************************************************'
		echo "Ошибка: IP адрес абонента ${IPAB}, уже используеться..."
		echo '***********************************************************************'
		exit 1
	#Проверка использования порта на свиче
	elif [ "$CHKUSEPORT" ]; then
		echo '***********************************************************************'
		echo "Ошибка: Порт ${PORT}, на свиче ${IPSW}, уже используеться абонентом ${CHKUSEPORTLOGIN}..."
		echo '***********************************************************************'
		exit 1
	else
		#Запуск функции: 'Добавление в список выключеной авторизации' и передача аргумента для отключения вывода сообщений
		#addalwon '1'
		#Добавление настроек абонента
		sed -ri "s/(.{1,}\"${LOGIN}\".{1,}\")switch(\".{1,}\")port(\".{1,})/\1${IPSW}\2${PORT}\3/" $DHCPCLASS
		dhcptestrestcfg
		echo '***********************************************************************'
		echo "DHCP настройки абонента, добавлены..."
		echo "IP адрес абонента: ${IPAB}"
		echo "IP адрес свича: ${IPSW}"
		echo "Порт свича: ${PORT}"
		echo '***********************************************************************'
		#Добавление записи в лог
		echo "$DATEFR $I $0 DHCP конфигурации абонента $IPAB добавлены..." >> $LOG
	fi
}
delabon() {
	#Проверяю настроен ли этот IP адрес
	if [ "`egrep '\"switch\"|\"port\"' $DHCPCLASS | grep -wo $LOGIN`" ]; then
		echo '***********************************************************************'
		echo "Ошибка: Настройки абонента ${IPAB}, не найдены..."
		echo '***********************************************************************'
		exit 1
	else
		#Удаление настроек абонента
		sed -ri "s/(.{1,}\"${LOGIN}\".{1,}\")${NETTOSW}[0-9]{1,3}(\".{1,}4\,2\)\)\=\")[0-9]{1,2}(\".{1,})/\1switch\2port\3/" $DHCPCLASS
		#delalwon '1'
		dhcptestrestcfg
		echo '************************************************************************'
		#echo "DHCP настройки абонента, удалены..."
		echo "IP адрес абонента: ${IPAB}"
		echo '************************************************************************'
		#Добавляем запись в лог
		$echo "$DATEFR $I $0 DHCP конфигурации абонента $IPAB удалены..." >> $LOG
	fi
}
dhcptestrestcfg() {
	local DHCPTESTCFG=`/etc/init.d/dhcpd configtest 2> /tmp/dhcpconfigtest.tmp; cat /tmp/dhcpconfigtest.tmp | grep Syntax\:\ OK`
	#Проверка конфигурационного файла DHCP сервера на синтаксис
	if [ "$DHCPTESTCFG" ]; then
		#Перезапуск службы DHCP
		echo '***********************************************************************'
		echo "DHCP Сервер перегружается..."
		echo '***********************************************************************'
		/etc/init.d/dhcpd restart
		rm -f /tmp/dhcpconfigtest.tmp
	else
		echo '***********************************************************************'
		echo "Ошибка: Конфигурационные файлы не прошли проверку на синтаксис..."
		echo '***********************************************************************'
		exit 1
	fi
}
checkip() {
	local SHOWCLASS=`egrep -v '\"switch\"|\"port\"' $DHCPCLASS | grep -wo $LOGIN`
#	local SHOWALWON=`grep -w ${IPAB} $ALWONLST`
#	local CHKDHCPLOG=`grep -m 1 -wo $IPAB $DHCPLOG`
	local SHOWSWITCH=`grep -w $LOGIN $DHCPCLASS | egrep -wo "${NETTOSW}[0-9]{1,3}"`
	local SHOWPORT=`grep -w $LOGIN $DHCPCLASS | egrep -o '4,2\)\)="[0-9]{1,2}"' | sed -r 's/.{1,}\"([0-9]{1,2})\"/\1/'`
	local CHKARP=`arp $IPAB | grep -o no`
	clear
#	if [ ! "$SHOWCLASS" ] && [ ! "$SHOWALWON" ] && [ ! "$CHKDHCPLOG" ] && [ "$CHKARP" ];; then
	if [ ! "$SHOWCLASS" ] && [ ! "$CHKDHCPLOG" ] && [ "$CHKARP" ]; then
		clear
		echo "Данный IP адрес абонента ${IPAB}, ни в ARP, ни в логах, ни в настройках не встречаеться..."
		exit 1
	else
		if [ ! "$CHKARP" ]; then
			echo "ARP соотвествие для данного абонента:"
			echo '===================================ARP================================='
			arp $IPAB
			echo '=================================END-ARP==============================='
			echo
		else
			echo '===================================ARP================================='
			echo "Внимание: абонент ${LOGIN} не найден в ARP таблице..."
			echo '=================================END-ARP==============================='
			echo
		fi
		if [ "$SHOWCLASS" ]; then
			echo "Настройки для данного абонента из файла кон-ций ${DHCPCLASS}:"
			echo '============================SWITCH-SET================================='
			echo "IP-адрес свича: ${SHOWSWITCH}   Порт: ${SHOWPORT}"
			echo '==========================END-SWITCH-SET==============================='
			echo
		else
			echo '============================SWITCH-SET================================='
			echo "Внимание: абонент ${LOGIN} не привязан ни к порту, ни к свичу..."
			echo '==========================END-SWITCH-SET==============================='
			echo
			exit 1
		fi
	fi
}
showsw() {
	clear
	local CNT=`grep -w $IPSW $DHCPDIR/*_classes|wc -l`
	echo "$IPSW"
	grep -w $IPSW $DHCPDIR/*_classes | sed -r 's/.{1,}class\ \"(tern[0-9]{1,})\".{1,}4\,2\)\)\=\"([0-9]{1,2})\".{1,}/порт\: \2\ Логин: \1/' | sort -V
	echo "Всего: $CNT"
}
case "$1" in
	addabon)
		check $1 $2 $3 $4
	;;
	delabon)
		check $1 $2
	;;
	checkip)
		check $1 $2
	;;
	showsw)
		check $1 $2
	;;
	*)
		clear
		echo '***********************************************************************'
		echo '*********************ternnet v1.6 by THE DECAL...**********************'
		echo '***********************************************************************'
		echo 'Используемые команды: addabon [IP адрес абонента] [IP адрес свича] [Порт абонента] - Добавить DHCP настройки абонента'
		echo '                      delabon [IP адрес абонента] - Удалить DHCP настройки абонента'
		echo '                      checkip [IP адрес абонента] - Показать и проверить, настройки и логи, по данному IP адресу абонента'
		echo '                      showsw  [IP адрес свича] - Показать порты свича'
		echo ''
		echo '-----------------------------------------------------------------------------'
		echo 'IP адрес абонента можно вводить, что с первыми двумя октетами, что без...'
		echo 'Так-же IP адрес свича можно вводить, что с первыми тремя октетами, что без...'
		echo '-----------------------------------------------------------------------------'
		echo '***********************************************************************'
		exit 1
esac
